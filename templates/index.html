<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kokoro TTS ä¸­æ–‡ç‰ˆ - æµ‹è¯•åº”ç”¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 1200px;
            backdrop-filter: blur(10px);
        }
        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin: 5px;
        }
        .status-online { background: rgba(40, 167, 69, 0.2); color: #28a745; border: 1px solid #28a745; }
        .status-offline { background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid #dc3545; }
        .voice-category {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .voice-btn {
            margin: 3px;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .generation-area {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        .audio-player {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .generation-info {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .example-texts {
            background: #fff3cd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .example-text {
            cursor: pointer;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ffc107;
            transition: all 0.2s;
        }
        .example-text:hover {
            background: #ffc107;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- é¡µé¢å¤´éƒ¨ -->
            <div class="header">
                <h1><i class="fas fa-microphone-alt"></i> Kokoro TTS ä¸­æ–‡ç‰ˆ</h1>
                <p class="mb-3">åŠŸèƒ½å¼ºå¤§çš„ä¸­æ–‡æ–‡æœ¬è½¬è¯­éŸ³æµ‹è¯•å¹³å°</p>
                <div>
                    <span class="status-badge {{ 'status-online' if kokoro_available else 'status-offline' }}">
                        <i class="fas fa-{{ 'check-circle' if kokoro_available else 'times-circle' }}"></i>
                        Kokoro {{ 'å·²åŠ è½½' if kokoro_available else 'æœªå®‰è£…' }}
                    </span>
                    <span class="status-badge status-online">
                        <i class="fas fa-microchip"></i> {{ device.upper() }}
                    </span>
                    <span class="status-badge status-online">
                        <i class="fas fa-music"></i> 
                        {{ voices.female|length + voices.male|length + voices.english|length }} éŸ³è‰²
                    </span>
                </div>
            </div>

            <div class="p-4">
                <div class="row">
                    <!-- å·¦ä¾§ï¼šéŸ³è‰²é€‰æ‹© -->
                    <div class="col-md-4">
                        <h4><i class="fas fa-palette"></i> éŸ³è‰²é€‰æ‹©</h4>
                        
                        <!-- å¥³å£°éŸ³è‰² -->
                        <div class="voice-category">
                            <h6><i class="fas fa-female text-pink"></i> å¥³å£°éŸ³è‰² ({{ voices.female|length }}ä¸ª)</h6>
                            <div id="female-voices">
                                {% for voice in voices.female %}
                                <button class="btn btn-outline-pink voice-btn" data-voice="{{ voice }}" data-gender="female">
                                    {{ voice }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- ç”·å£°éŸ³è‰² -->
                        <div class="voice-category">
                            <h6><i class="fas fa-male text-primary"></i> ç”·å£°éŸ³è‰² ({{ voices.male|length }}ä¸ª)</h6>
                            <div id="male-voices">
                                {% for voice in voices.male %}
                                <button class="btn btn-outline-primary voice-btn" data-voice="{{ voice }}" data-gender="male">
                                    {{ voice }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- è‹±æ–‡éŸ³è‰² -->
                        <div class="voice-category">
                            <h6><i class="fas fa-globe text-success"></i> è‹±æ–‡éŸ³è‰² ({{ voices.english|length }}ä¸ª)</h6>
                            <div id="english-voices">
                                {% for voice in voices.english %}
                                <button class="btn btn-outline-success voice-btn" data-voice="{{ voice }}" data-gender="english">
                                    {{ voice }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šæ–‡æœ¬è¾“å…¥å’Œç”Ÿæˆ -->
                    <div class="col-md-8">
                        <div class="generation-area">
                            <h4><i class="fas fa-edit"></i> æ–‡æœ¬è¾“å…¥</h4>
                            
                            <!-- ç¤ºä¾‹æ–‡æœ¬ -->
                            <div class="example-texts">
                                <h6><i class="fas fa-lightbulb"></i> ç‚¹å‡»ä½¿ç”¨ç¤ºä¾‹æ–‡æœ¬ï¼š</h6>
                                <div class="example-text" data-text="æ¬¢è¿ä½¿ç”¨Kokoro TTSä¸­æ–‡ç‰ˆï¼è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æ–‡æœ¬è½¬è¯­éŸ³ç³»ç»Ÿã€‚">
                                    ğŸ“¢ æ¬¢è¿è¯ - æ¬¢è¿ä½¿ç”¨Kokoro TTSä¸­æ–‡ç‰ˆï¼
                                </div>
                                <div class="example-text" data-text="æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿã€‚å¤œæ¥é£é›¨å£°ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚">
                                    ğŸŒ¸ å¤è¯— - æ˜¥æ™“ï¼ˆå­Ÿæµ©ç„¶ï¼‰
                                </div>
                                <div class="example-text" data-text="äººå·¥æ™ºèƒ½æŠ€æœ¯æ­£åœ¨å¿«é€Ÿå‘å±•ï¼Œè¯­éŸ³åˆæˆæ˜¯å…¶ä¸­é‡è¦çš„åº”ç”¨æ–¹å‘ä¹‹ä¸€ã€‚">
                                    ğŸ¤– ç§‘æŠ€ - äººå·¥æ™ºèƒ½ä»‹ç»
                                </div>
                                <div class="example-text" data-text="Hello, welcome to Kokoro TTS! This is a powerful text-to-speech system.">
                                    ğŸŒ è‹±æ–‡ - Welcome message
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="text-input" class="form-label">è¾“å…¥æ–‡æœ¬ <span class="text-muted">(æœ€å¤š500å­—ç¬¦)</span></label>
                                <textarea id="text-input" class="form-control" rows="4" 
                                          placeholder="è¯·è¾“å…¥è¦è½¬æ¢ä¸ºè¯­éŸ³çš„æ–‡æœ¬..."></textarea>
                                <div class="mt-2">
                                    <span class="text-muted">å­—ç¬¦æ•°: </span>
                                    <span id="char-count">0</span>/500
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="selected-voice" class="form-label">é€‰ä¸­éŸ³è‰²</label>
                                    <input id="selected-voice" class="form-control" value="zf_001" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="language-select" class="form-label">è¯­è¨€</label>
                                    <select id="language-select" class="form-select">
                                        <option value="zh">ä¸­æ–‡</option>
                                        <option value="en">è‹±æ–‡</option>
                                    </select>
                                </div>
                            </div>

                            <button id="generate-btn" class="btn btn-primary btn-lg" 
                                    {{ 'disabled' if not kokoro_available }}>
                                <i class="fas fa-play"></i> ç”Ÿæˆè¯­éŸ³
                            </button>

                            <!-- åŠ è½½çŠ¶æ€ -->
                            <div id="loading" class="loading">
                                <div class="spinner"></div>
                                <p>æ­£åœ¨ç”Ÿæˆè¯­éŸ³ï¼Œè¯·ç¨å€™...</p>
                            </div>

                            <!-- éŸ³é¢‘æ’­æ”¾åŒºåŸŸ -->
                            <div id="audio-result" class="audio-player" style="display: none;">
                                <h5><i class="fas fa-volume-up"></i> ç”Ÿæˆç»“æœ</h5>
                                <audio id="audio-player" controls class="w-100 mb-3">
                                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                                </audio>
                                
                                <div id="generation-info" class="generation-info"></div>
                                
                                <div class="mt-3">
                                    <button id="download-btn" class="btn btn-success">
                                        <i class="fas fa-download"></i> ä¸‹è½½éŸ³é¢‘
                                    </button>
                                    <button id="regenerate-btn" class="btn btn-secondary">
                                        <i class="fas fa-redo"></i> é‡æ–°ç”Ÿæˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFilename = null;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            bindEventListeners();
            
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¥³å£°
            const firstFemaleVoice = document.querySelector('[data-gender="female"]');
            if (firstFemaleVoice) {
                selectVoice(firstFemaleVoice.dataset.voice, 'female');
            }
        }
        
        function bindEventListeners() {
            // éŸ³è‰²é€‰æ‹©æŒ‰é’®
            document.querySelectorAll('.voice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectVoice(this.dataset.voice, this.dataset.gender);
                });
            });
            
            // ç¤ºä¾‹æ–‡æœ¬ç‚¹å‡»
            document.querySelectorAll('.example-text').forEach(example => {
                example.addEventListener('click', function() {
                    document.getElementById('text-input').value = this.dataset.text;
                    updateCharCount();
                });
            });
            
            // æ–‡æœ¬è¾“å…¥å­—ç¬¦è®¡æ•°
            document.getElementById('text-input').addEventListener('input', updateCharCount);
            
            // ç”ŸæˆæŒ‰é’®
            document.getElementById('generate-btn').addEventListener('click', generateSpeech);
            
            // é‡æ–°ç”ŸæˆæŒ‰é’®
            document.getElementById('regenerate-btn').addEventListener('click', generateSpeech);
            
            // ä¸‹è½½æŒ‰é’®
            document.getElementById('download-btn').addEventListener('click', downloadAudio);
        }
        
        function selectVoice(voice, gender) {
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.voice-btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'btn-success', 'btn-pink');
                if (btn.dataset.gender === 'female') {
                    btn.classList.add('btn-outline-primary');
                } else if (btn.dataset.gender === 'male') {
                    btn.classList.add('btn-outline-primary');
                } else {
                    btn.classList.add('btn-outline-success');
                }
            });
            
            // é«˜äº®é€‰ä¸­çš„æŒ‰é’®
            const selectedBtn = document.querySelector(`[data-voice="${voice}"]`);
            if (selectedBtn) {
                selectedBtn.classList.remove('btn-outline-primary', 'btn-outline-success');
                if (gender === 'female') {
                    selectedBtn.classList.add('btn-primary');
                } else if (gender === 'male') {
                    selectedBtn.classList.add('btn-primary');
                } else {
                    selectedBtn.classList.add('btn-success');
                }
            }
            
            // æ›´æ–°é€‰ä¸­éŸ³è‰²æ˜¾ç¤º
            document.getElementById('selected-voice').value = voice;
            
            // æ ¹æ®éŸ³è‰²ç±»å‹è‡ªåŠ¨è®¾ç½®è¯­è¨€
            if (voice.startsWith('zf_') || voice.startsWith('zm_')) {
                document.getElementById('language-select').value = 'zh';
            } else {
                document.getElementById('language-select').value = 'en';
            }
        }
        
        function updateCharCount() {
            const text = document.getElementById('text-input').value;
            const count = text.length;
            document.getElementById('char-count').textContent = count;
            
            // è¶…å‡ºé™åˆ¶æ—¶æ˜¾ç¤ºè­¦å‘Š
            const countElement = document.getElementById('char-count');
            if (count > 500) {
                countElement.style.color = '#dc3545';
                countElement.parentElement.style.fontWeight = 'bold';
            } else {
                countElement.style.color = '#6c757d';
                countElement.parentElement.style.fontWeight = 'normal';
            }
        }
        
        async function generateSpeech() {
            const text = document.getElementById('text-input').value.trim();
            const voice = document.getElementById('selected-voice').value;
            const language = document.getElementById('language-select').value;
            
            if (!text) {
                alert('è¯·è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬');
                return;
            }
            
            if (text.length > 500) {
                alert('æ–‡æœ¬é•¿åº¦ä¸èƒ½è¶…è¿‡500å­—ç¬¦');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading(true);
            hideAudioResult();
            
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        voice: voice,
                        language: language
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayAudioResult(result);
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('generate-btn').disabled = show;
        }
        
        function hideAudioResult() {
            document.getElementById('audio-result').style.display = 'none';
        }
        
        function displayAudioResult(result) {
            // è®¾ç½®éŸ³é¢‘æº
            const audioPlayer = document.getElementById('audio-player');
            audioPlayer.src = result.audio_data;
            
            // æ˜¾ç¤ºç”Ÿæˆä¿¡æ¯
            const infoHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>éŸ³è‰²:</strong> ${result.voice}<br>
                        <strong>æ–‡æœ¬é•¿åº¦:</strong> ${result.text_length} å­—ç¬¦<br>
                        <strong>éŸ³é¢‘æ—¶é•¿:</strong> ${result.audio_length} ç§’
                    </div>
                    <div class="col-md-6">
                        <strong>ç”Ÿæˆæ—¶é—´:</strong> ${result.generation_time} ç§’<br>
                        <strong>é‡‡æ ·ç‡:</strong> ${result.sample_rate} Hz<br>
                        <strong>æ–‡ä»¶å:</strong> ${result.filename}
                    </div>
                </div>
            `;
            document.getElementById('generation-info').innerHTML = infoHtml;
            
            // ä¿å­˜æ–‡ä»¶åç”¨äºä¸‹è½½
            currentFilename = result.filename;
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('audio-result').style.display = 'block';
            
            // è‡ªåŠ¨æ’­æ”¾
            audioPlayer.play().catch(e => {
                console.log('è‡ªåŠ¨æ’­æ”¾è¢«æµè§ˆå™¨é˜»æ­¢ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾');
            });
        }
        
        function downloadAudio() {
            if (currentFilename) {
                window.open(`/api/download/${currentFilename}`);
            }
        }
    </script>
</body>
</html>